<!doctype html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <!-- iPadã§ç”»é¢ã„ã£ã±ã„ï¼‹ãƒãƒƒãƒ/ãƒ›ãƒ¼ãƒ ãƒãƒ¼å¯¾ç­– -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />

  <!-- iPadãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ ã—ãŸã¨ãã‚¢ãƒ—ãƒªã£ã½ãå…¨ç”»é¢ -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <title>ãƒ™ãƒ«ãƒãƒ¼ãƒ¢ãƒ‹ãƒ¼</title>
  <link href="https://fonts.googleapis.com/css2?family=Rounded+Mplus+1c:wght@400;700&display=swap" rel="stylesheet">

  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      width: 100%;
      overflow: hidden;
      background: #111;
      font-family: 'Rounded Mplus 1c', sans-serif;
    }
    * { box-sizing: border-box; }

    /* iOSã®å®‰å…¨é ˜åŸŸï¼ˆãƒãƒƒãƒ/ãƒ›ãƒ¼ãƒ ãƒãƒ¼ï¼‰ */
    body {
      padding: env(safe-area-inset-top)
               env(safe-area-inset-right)
               env(safe-area-inset-bottom)
               env(safe-area-inset-left);
      /* èª¤æ“ä½œï¼ˆãƒ€ãƒ–ãƒ«ã‚¿ãƒƒãƒ—æ‹¡å¤§ç­‰ï¼‰ã‚’æ¸›ã‚‰ã™ */
      touch-action: manipulation;
      -webkit-user-select: none;
      user-select: none;
    }

    .app-container {
      width: 100%;
      height: 100%;
      min-height: 100svh; /* iOS Safariå¯¾ç­– */
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 16px;
      gap: 12px;
    }

    .title {
      font-size: clamp(28px, 3.6vw, 56px);
      font-weight: 700;
      color: #ffffff;
      margin: 0;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.35);
      letter-spacing: 0.02em;
    }

    .controls {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      justify-content: center;
      align-items: center;
      width: min(980px, 100%);
    }

    .mode-button {
      padding: 12px 18px;
      font-size: 16px;
      font-weight: 700;
      border: none;
      border-radius: 999px;
      cursor: pointer;
      transition: transform 0.15s ease, box-shadow 0.15s ease, filter 0.15s ease;
      font-family: 'Rounded Mplus 1c', sans-serif;
      box-shadow: 0 6px 16px rgba(0,0,0,0.25);
      white-space: nowrap;
    }
    .mode-button:active { transform: scale(0.97); }
    .mode-button:hover { filter: brightness(1.03); }

    .mode-button.free { background: #ffffff; color: #667eea; }
    .mode-button.practice { background: #ffd700; color: #333333; }
    .mode-button.demo { background: #00e5ff; color: #00303a; }
    .mode-button.stop { background: #ff5a5f; color: #ffffff; }

    .mode-button.active {
      transform: scale(1.03);
      box-shadow: 0 8px 20px rgba(255,255,255,0.22);
    }

    .practice-info {
      color: #ffffff;
      font-size: clamp(14px, 1.8vw, 20px);
      text-shadow: 1px 1px 2px rgba(0,0,0,0.35);
      text-align: center;
      width: min(980px, 100%);
      min-height: 1.4em;
    }

    /* æ¨ªæŒã¡ï¼ˆiPadãƒ©ãƒ³ãƒ‰ã‚¹ã‚±ãƒ¼ãƒ—ï¼‰ã§ãƒ™ãƒ«ã‚’å¤§ããã—ã¦ä½™ç™½æ¸›ã‚‰ã™ */
    .bells-container {
      width: min(980px, 100%);
      display: grid;
      gap: clamp(10px, 1.6vw, 18px);
      justify-content: center;
      align-content: center;
      /* ç”»é¢ã‚µã‚¤ã‚ºã«å¿œã˜ã¦è‡ªå‹•ã§åˆ—æ•°èª¿æ•´ */
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    }

    .bell {
      position: relative;
      width: 100%;
      aspect-ratio: 5 / 7; /* è¦‹ãŸç›®ã‚’ç¶­æŒã—ã¦ä¼¸ç¸® */
      cursor: pointer;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .bell-body {
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }

    .bell-top {
      width: 28%;
      height: 11%;
      background: #8b7355;
      border-radius: 999px 999px 0 0;
      margin-bottom: -6px;
      z-index: 2;
    }

    .bell-shape {
      width: 78%;
      height: 70%;
      border-radius: 42% 42% 50% 50%;
      box-shadow:
        0 10px 22px rgba(0,0,0,0.30),
        inset -6px -6px 16px rgba(0,0,0,0.22),
        inset 6px 6px 16px rgba(255,255,255,0.25);
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      transform-origin: center top;
    }

    .bell-shape.ringing { animation: ring 0.24s ease-in-out; }
    .bell-shape.highlight {
      animation: glow 0.85s ease-in-out infinite;
      box-shadow:
        0 0 32px rgba(255,255,255,0.90),
        0 10px 22px rgba(0,0,0,0.30),
        inset -6px -6px 16px rgba(0,0,0,0.22),
        inset 6px 6px 16px rgba(255,255,255,0.25);
    }

    @keyframes ring {
      0%, 100% { transform: rotate(0deg) scale(1); }
      25% { transform: rotate(-9deg) scale(1.02); }
      75% { transform: rotate(9deg) scale(1.02); }
    }

    @keyframes glow {
      0%, 100% { filter: brightness(1.45); transform: scale(1.05); }
      50% { filter: brightness(1.8); transform: scale(1.10); }
    }

    .bell-note {
      font-size: clamp(22px, 3vw, 34px);
      font-weight: 700;
      color: #8b4513;
      text-shadow: 1px 1px 2px rgba(255,255,255,0.55);
    }

    .bell-label {
      font-size: clamp(12px, 1.6vw, 16px);
      font-weight: 700;
      color: #ffffff;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.55);
      letter-spacing: 0.06em;
    }

    /* ã•ã‚‰ã«æ¨ªé•·ã®ã¨ãï¼š7å€‹ãŒæ°—æŒã¡ã‚ˆãä¸¦ã¶ã‚ˆã†ã« */
    @media (min-width: 900px) and (orientation: landscape) {
      .bells-container {
        grid-template-columns: repeat(7, minmax(110px, 1fr));
      }
    }
  </style>
</head>

<body>
  <div class="app-container">
    <h1 class="title" id="title">ãƒ™ãƒ«ãƒãƒ¼ãƒ¢ãƒ‹ãƒ¼</h1>

    <div class="controls">
      <button class="mode-button free active" id="freeMode">è‡ªç”±æ¼”å¥</button>
      <button class="mode-button practice" id="practiceMode">ãã‚‰ãã‚‰æ˜Ÿã‚’ç·´ç¿’ï¼ˆå¾…ã¡ã¤ãï¼‰</button>
      <button class="mode-button demo" id="demoPlay">ãƒ‡ãƒ¢æ¼”å¥ï¼ˆãã‚‰ãã‚‰æ˜Ÿï¼‰</button>
      <button class="mode-button stop" id="stopAll">åœæ­¢</button>
    </div>

    <div class="practice-info" id="practiceInfo" style="display:none;"></div>
    <div class="bells-container" id="bellsContainer"></div>
  </div>

  <script>
    const notes = [
      { note: 'ãƒ‰', frequency: 261.63, label: 'C', color: '#ff4444' },
      { note: 'ãƒ¬', frequency: 293.66, label: 'D', color: '#ff8833' },
      { note: 'ãƒŸ', frequency: 329.63, label: 'E', color: '#ffdd33' },
      { note: 'ãƒ•ã‚¡', frequency: 349.23, label: 'F', color: '#44dd44' },
      { note: 'ã‚½', frequency: 392.00, label: 'G', color: '#3399ff' },
      { note: 'ãƒ©', frequency: 440.00, label: 'A', color: '#4488ff' },
      { note: 'ã‚·', frequency: 493.88, label: 'B', color: '#ff66cc' }
    ];

    // ãã‚‰ãã‚‰æ˜Ÿï¼ˆãƒ‰ãƒ»ãƒ‰ãƒ»ã‚½â€¦ï¼‰
    const twinkleSong = [
      'ãƒ‰', 'ãƒ‰', 'ã‚½', 'ã‚½', 'ãƒ©', 'ãƒ©', 'ã‚½',
      'ãƒ•ã‚¡', 'ãƒ•ã‚¡', 'ãƒŸ', 'ãƒŸ', 'ãƒ¬', 'ãƒ¬', 'ãƒ‰',
      'ã‚½', 'ã‚½', 'ãƒ•ã‚¡', 'ãƒ•ã‚¡', 'ãƒŸ', 'ãƒŸ', 'ãƒ¬',
      'ã‚½', 'ã‚½', 'ãƒ•ã‚¡', 'ãƒ•ã‚¡', 'ãƒŸ', 'ãƒŸ', 'ãƒ¬',
      'ãƒ‰', 'ãƒ‰', 'ã‚½', 'ã‚½', 'ãƒ©', 'ãƒ©', 'ã‚½',
      'ãƒ•ã‚¡', 'ãƒ•ã‚¡', 'ãƒŸ', 'ãƒŸ', 'ãƒ¬', 'ãƒ¬', 'ãƒ‰'
    ];

    // ===== çŠ¶æ…‹ =====
    let practiceMode = false;
    let currentNoteIndex = 0;
    let bellElements = {};
    let audioContext;

    // åŒæ™‚æŠ¼ã—ï¼ˆå’ŒéŸ³ï¼‰å¯¾å¿œï¼špointerIdã”ã¨ã«æŠ¼ä¸‹ä¸­ãƒãƒ¼ãƒˆã‚’ä¿æŒ
    const activePointers = new Map();

    // è‡ªå‹•æ¼”å¥/ãƒ‡ãƒ¢ç”¨
    let autoplayTimer = null;
    let autoplayIndex = 0;
    let isAutoplay = false;

    // ç·´ç¿’ï¼ˆå¾…ã¡ã¤ãï¼‰ï¼šæ¬¡ã®éŸ³ã‚’å…‰ã‚‰ã›ã¦ã‹ã‚‰ã€Œå¾…ã¤ã€æ™‚é–“ï¼ˆmsï¼‰
    const PRACTICE_WAIT_MS = 1200;
    // ãƒ‡ãƒ¢/è‡ªå‹•æ¼”å¥ã®ãƒ†ãƒ³ãƒï¼ˆmsï¼‰
    const DEMO_TEMPO_MS = 520;

    function initAudio() {
      if (!audioContext) {
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
      }
      if (audioContext.state === 'suspended') {
        audioContext.resume();
      }
    }

    function playBellSound(frequency) {
      initAudio();

      const osc = audioContext.createOscillator();
      const gain = audioContext.createGain();

      osc.type = 'sine';
      osc.frequency.setValueAtTime(frequency, audioContext.currentTime);

      gain.gain.setValueAtTime(0.28, audioContext.currentTime);
      gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 1.2);

      osc.connect(gain);
      gain.connect(audioContext.destination);

      osc.start(audioContext.currentTime);
      osc.stop(audioContext.currentTime + 1.2);
    }

    function adjustBrightness(hex, percent) {
      const num = parseInt(hex.replace('#', ''), 16);
      const r = Math.min(255, Math.floor((num >> 16) * percent));
      const g = Math.min(255, Math.floor(((num >> 8) & 0x00FF) * percent));
      const b = Math.min(255, Math.floor((num & 0x0000FF) * percent));
      return '#' + ((r << 16) | (g << 8) | b).toString(16).padStart(6, '0');
    }

    function stopAutoplay() {
      if (autoplayTimer) clearTimeout(autoplayTimer);
      autoplayTimer = null;
      isAutoplay = false;
      autoplayIndex = 0;
    }

    function clearHighlights() {
      Object.values(bellElements).forEach(el => el.classList.remove('highlight'));
    }

    function ringVisual(note) {
      const el = bellElements[note];
      if (!el) return;
      el.classList.add('ringing');
      setTimeout(() => el.classList.remove('ringing'), 240);
    }

    function highlightNote(note) {
      clearHighlights();
      if (bellElements[note]) bellElements[note].classList.add('highlight');
    }

    function updatePracticeInfo(text) {
      const info = document.getElementById('practiceInfo');
      info.textContent = text;
    }

    // ===== ç·´ç¿’ï¼ˆå¾…ã¡ã¤ãï¼‰ =====
    function startPractice() {
      stopAutoplay();
      practiceMode = true;
      currentNoteIndex = 0;

      document.getElementById('practiceInfo').style.display = 'block';
      document.getElementById('freeMode').classList.remove('active');
      document.getElementById('practiceMode').classList.add('active');

      showNextPracticeNote();
    }

    function showNextPracticeNote() {
      if (!practiceMode) return;

      if (currentNoteIndex >= twinkleSong.length) {
        clearHighlights();
        updatePracticeInfo('ğŸ‰ å®Œç’§ï¼ãã‚‰ãã‚‰æ˜Ÿã‚’ãƒã‚¹ã‚¿ãƒ¼ã—ã¾ã—ãŸï¼');
        // ã¡ã‚‡ã„å¾…ã£ã¦æœ€åˆã«æˆ»ã™
        setTimeout(() => {
          if (!practiceMode) return;
          currentNoteIndex = 0;
          showNextPracticeNote();
        }, 1600);
        return;
      }

      const next = twinkleSong[currentNoteIndex];
      highlightNote(next);

      updatePracticeInfo(`â™ª ${currentNoteIndex + 1} / ${twinkleSong.length}ã€€æ¬¡ï¼š${next}ï¼ˆå¾…ã¡æ™‚é–“ã‚ã‚Šï¼‰`);
      // å¾…ã¡æ™‚é–“ã§å­ã©ã‚‚ãŒæº–å‚™ã§ãã‚‹ã‚ˆã†ã«ï¼ˆæŠ¼ã—ã¦ã‚‚OKï¼‰
      // ä½•ã‚‚ã—ãªãã¦ã‚‚æ¬¡ã«é€²ã‚ãŸã„å ´åˆã¯ã“ã“ã§è‡ªå‹•ã§éŸ³ã‚’é³´ã‚‰ã™ç­‰ã‚‚å¯èƒ½ã ãŒã€ä»Šå›ã¯ã€Œå¾…ã¤ã€ã ã‘
      // ï¼æŠ¼ã™ã¾ã§é€²ã¾ãªã„è¨­è¨ˆ
    }

    function checkPractice(playedNote) {
      if (!practiceMode) return;

      const expected = twinkleSong[currentNoteIndex];
      if (playedNote !== expected) return;

      // æ­£è§£ï¼šå°‘ã—ã ã‘ä½™éŸ»â†’æ¬¡ã¸
      clearHighlights();
      currentNoteIndex++;
      setTimeout(showNextPracticeNote, 260);
    }

    function setFreeMode() {
      stopAutoplay();
      practiceMode = false;
      currentNoteIndex = 0;

      document.getElementById('practiceInfo').style.display = 'none';
      document.getElementById('freeMode').classList.add('active');
      document.getElementById('practiceMode').classList.remove('active');
      clearHighlights();
    }

    // ===== ãƒ‡ãƒ¢/è‡ªå‹•æ¼”å¥ï¼ˆãã‚‰ãã‚‰æ˜Ÿï¼‰ =====
    function startDemo() {
      stopAutoplay();
      practiceMode = false;
      document.getElementById('practiceInfo').style.display = 'block';
      document.getElementById('freeMode').classList.remove('active');
      document.getElementById('practiceMode').classList.remove('active');
      updatePracticeInfo('ğŸµ ãƒ‡ãƒ¢æ¼”å¥ä¸­ï¼ˆãã‚‰ãã‚‰æ˜Ÿï¼‰');

      isAutoplay = true;
      autoplayIndex = 0;

      const step = () => {
        if (!isAutoplay) return;

        if (autoplayIndex >= twinkleSong.length) {
          isAutoplay = false;
          clearHighlights();
          updatePracticeInfo('âœ… ãƒ‡ãƒ¢æ¼”å¥ãŠã‚ã‚Š');
          return;
        }

        const n = twinkleSong[autoplayIndex];
        highlightNote(n);

        // éŸ³ã‚’é³´ã‚‰ã™
        const noteObj = notes.find(x => x.note === n);
        if (noteObj) {
          ringVisual(n);
          playBellSound(noteObj.frequency);
        }

        autoplayIndex++;
        autoplayTimer = setTimeout(step, DEMO_TEMPO_MS);
      };

      step();
    }

    function stopAll() {
      stopAutoplay();
      clearHighlights();
      updatePracticeInfo('');
      document.getElementById('practiceInfo').style.display = practiceMode ? 'block' : 'none';
    }

    // ===== ãƒ™ãƒ«ç”Ÿæˆï¼ˆiPadã§å’ŒéŸ³ï¼špointerdownæ¡ç”¨ï¼‰ =====
    function createBells() {
      const container = document.getElementById('bellsContainer');
      container.innerHTML = '';
      bellElements = {};

      notes.forEach(({ note, frequency, label, color }) => {
        const bell = document.createElement('div');
        bell.className = 'bell';
        bell.dataset.note = note;

        const bright = adjustBrightness(color, 1.2);
        bell.innerHTML = `
          <div class="bell-body">
            <div class="bell-top"></div>
            <div class="bell-shape" style="background: linear-gradient(180deg, ${color} 0%, ${bright} 50%, ${color} 100%);">
              <div class="bell-note">${note}</div>
            </div>
            <div class="bell-label">${label}</div>
          </div>
        `;

        const bellShape = bell.querySelector('.bell-shape');
        bellElements[note] = bellShape;

        // ã‚¯ãƒªãƒƒã‚¯ã‚ˆã‚Špointerã‚¤ãƒ™ãƒ³ãƒˆã®ã»ã†ãŒåŒæ™‚æŠ¼ã—ã«å¼·ã„
        bell.addEventListener('pointerdown', (e) => {
          e.preventDefault(); // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚„ãƒ€ãƒ–ãƒ«ã‚¿ãƒƒãƒ—ç³»æŠ‘æ­¢
          bell.setPointerCapture?.(e.pointerId);

          // åŒã˜pointerã§é€£æ‰“æ‰±ã„ã«ãªã‚‰ãªã„ã‚ˆã†è¨˜éŒ²
          activePointers.set(e.pointerId, note);

          ringVisual(note);
          playBellSound(frequency);

          if (practiceMode) checkPractice(note);
        }, { passive: false });

        bell.addEventListener('pointerup', (e) => {
          activePointers.delete(e.pointerId);
        });

        bell.addEventListener('pointercancel', (e) => {
          activePointers.delete(e.pointerId);
        });

        container.appendChild(bell);
      });
    }

    // ===== ãƒœã‚¿ãƒ³ =====
    document.getElementById('freeMode').addEventListener('click', () => {
      setFreeMode();
    });

    document.getElementById('practiceMode').addEventListener('click', () => {
      startPractice();
    });

    document.getElementById('demoPlay').addEventListener('click', () => {
      startDemo();
    });

    document.getElementById('stopAll').addEventListener('click', () => {
      stopAll();
    });

    // åˆæœŸè¡¨ç¤º
    createBells();
    setFreeMode();

    // iOSã§éŸ³ãŒé³´ã‚‰ãªã„å¯¾ç­–ï¼šæœ€åˆã®ã‚¿ãƒƒãƒ—ã§AudioContextèµ·å‹•
    window.addEventListener('pointerdown', () => initAudio(), { once: true });
  </script>
</body>
</html>
