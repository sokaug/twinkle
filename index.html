<!doctype html>
<html lang="ja">
<head>
<meta charset="UTF-8">

<!-- iPad 全画面対応 -->
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

<title>ベルハーモニー</title>

<link href="https://fonts.googleapis.com/css2?family=Rounded+Mplus+1c:wght@400;700&display=swap" rel="stylesheet">

<style>
html, body {
  margin: 0;
  padding: 0;
  width: 100%;
  height: 100%;
  overflow: hidden;
}

body {
  font-family: 'Rounded Mplus 1c', sans-serif;
  background: #111;
  padding:
    env(safe-area-inset-top)
    env(safe-area-inset-right)
    env(safe-area-inset-bottom)
    env(safe-area-inset-left);
  touch-action: manipulation;
  user-select: none;
}

* { box-sizing: border-box; }

.app-container {
  width: 100%;
  height: 100%;
  min-height: 100svh;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  padding: 16px;
}

.title {
  font-size: clamp(28px, 4vw, 48px);
  font-weight: 700;
  color: #fff;
  margin-bottom: 16px;
}

.controls {
  display: flex;
  gap: 12px;
  flex-wrap: wrap;
  justify-content: center;
  margin-bottom: 12px;
}

.mode-button {
  padding: 12px 20px;
  border-radius: 999px;
  border: none;
  font-weight: 700;
  cursor: pointer;
}

.mode-button.free { background:#fff; color:#667eea; }
.mode-button.demo { background:#ff69b4; color:#fff; }
.mode-button.beginner { background:#90ee90; }
.mode-button.practice { background:#ffd700; }

.mode-button.active {
  box-shadow: 0 0 12px rgba(255,255,255,0.6);
}

.practice-info {
  color: #fff;
  margin-bottom: 10px;
}

.bells-container {
  width: min(1000px, 100%);
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 14px;
}

.bell {
  aspect-ratio: 5 / 7;
  display: flex;
  justify-content: center;
  align-items: center;
}

.bell-shape {
  width: 100%;
  height: 100%;
  border-radius: 40% 40% 50% 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  background: gold;
  transition: 0.3s;
}

.bell-shape.highlight {
  filter: brightness(1.8);
  transform: scale(1.1);
}

.bell-shape.dimmed {
  opacity: 0.3;
}
</style>
</head>

<body>
<div class="app-container">
  <h1 class="title">ベルハーモニー</h1>

  <div class="controls">
    <button class="mode-button free active" id="freeMode">自由演奏</button>
    <button class="mode-button demo" id="demoMode">デモ</button>
    <button class="mode-button beginner" id="beginnerMode">初級</button>
    <button class="mode-button practice" id="practiceMode">中級</button>
  </div>

  <div class="practice-info" id="practiceInfo" style="display:none"></div>
  <div class="bells-container" id="bellsContainer"></div>
</div>

<script>
/* ========= AudioContext（iOS対策） ========= */
let audioContext;
function initAudio() {
  if (!audioContext) {
    audioContext = new (window.AudioContext || window.webkitAudioContext)();
  }
  if (audioContext.state === 'suspended') {
    audioContext.resume();
  }
}
window.addEventListener('pointerdown', initAudio, { once:true });

/* ========= データ ========= */
const notes = [
  { note:'ド', freq:261.63 },
  { note:'レ', freq:293.66 },
  { note:'ミ', freq:329.63 },
  { note:'ファ', freq:349.23 },
  { note:'ソ', freq:392.00 },
  { note:'ラ', freq:440.00 },
  { note:'シ', freq:493.88 }
];

const twinkle = [
 'ド','ド','ソ','ソ','ラ','ラ','ソ',
 'ファ','ファ','ミ','ミ','レ','レ','ド'
];

let mode = 'free';
let index = 0;
let bells = {};
let timer = null;

/* ========= 音 ========= */
function play(freq) {
  initAudio();
  const o = audioContext.createOscillator();
  const g = audioContext.createGain();
  o.type = 'sine';
  o.frequency.value = freq;
  g.gain.setValueAtTime(0.4, audioContext.currentTime);
  g.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 1);
  o.connect(g).connect(audioContext.destination);
  o.start();
  o.stop(audioContext.currentTime + 1);
}

/* ========= UI ========= */
function createBells() {
  const c = document.getElementById('bellsContainer');
  c.innerHTML = '';
  notes.forEach(n=>{
    const d = document.createElement('div');
    d.className = 'bell';
    d.innerHTML = `<div class="bell-shape">${n.note}</div>`;
    const s = d.querySelector('.bell-shape');
    bells[n.note] = s;
    d.onclick = ()=>{
      if(mode==='demo') return;
      if(mode!=='free' && n.note!==twinkle[index]) return;
      play(n.freq);
      if(mode!=='free'){
        index++;
        highlight();
      }
    };
    c.appendChild(d);
  });
}

function highlight(){
  Object.values(bells).forEach(b=>b.classList.remove('highlight','dimmed'));
  if(index>=twinkle.length) return;
  const n = twinkle[index];
  bells[n].classList.add('highlight');
  if(mode==='beginner'){
    Object.keys(bells).forEach(k=>{
      if(k!==n) bells[k].classList.add('dimmed');
    });
  }
}

/* ========= モード ========= */
function setMode(m){
  clearTimeout(timer);
  mode = m;
  index = 0;
  document.querySelectorAll('.mode-button').forEach(b=>b.classList.remove('active'));
  document.getElementById(m+'Mode').classList.add('active');
  document.getElementById('practiceInfo').style.display = m==='free'?'none':'block';
  highlight();
  if(m==='demo') demo();
}

function demo(){
  if(index>=twinkle.length) return;
  const n = twinkle[index];
  play(notes.find(x=>x.note===n).freq);
  bells[n].classList.add('highlight');
  timer = setTimeout(()=>{
    bells[n].classList.remove('highlight');
    index++;
    demo();
  }, 800);
}

/* ========= ボタン ========= */
freeMode.onclick=()=>setMode('free');
demoMode.onclick=()=>setMode('demo');
beginnerMode.onclick=()=>setMode('beginner');
practiceMode.onclick=()=>setMode('practice');

/* ========= 起動 ========= */
createBells();
</script>
</body>
</html>
